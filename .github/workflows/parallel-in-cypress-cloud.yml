name: WIP-dasboard
on:
  workflow_dispatch:

jobs:
  cypress-install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Run Cypress tests daily ğŸŒ 
        uses: cypress-io/github-action@v5.3.1
        with:
          runTests: false

          
  cypress-run:
    runs-on: ubuntu-latest
    needs: cypress-install
    strategy:
      fail-fast: false
      matrix:
        containers: [1,2,3]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Run Cypress tests daily ğŸŒ
        id: test_execution
        uses: cypress-io/github-action@v5.3.1
        with:
          fail-fast: false
          command: npm run cy:qa:regression:allure:record


      - name: Upload allure test results  ğŸ“
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: allure-results
          path: cypress/reports/allure-results/
          retention-days: 7


  cypress-upload:
    runs-on: ubuntu-latest
    needs: [cypress-install, cypress-run]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download allure test results  ğŸ“
        uses: actions/download-artifact@v3
        with:
          name: allure-results
          path: cypress/reports/allure-results

      - name: Generate allure report ğŸ”– 
        uses: cypress-io/github-action@v5.3.1
        with:
          command: npm run allure:report
      
      - name: Upload allure test report  ğŸ“
        uses: actions/upload-artifact@v3
        with:
          name: allure-test-report
          path: cypress/reports/allure-report/
      
      - name: Deploy test report ğŸ›¸
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./cypress/reports/allure-report

      - name: notify slack channel ğŸ“£
        id: slack
        uses: slackapi/slack-github-action@v1.23.0
        if: always()
        with:
          payload: |
            {
              "environment": "QA",
              "test_run_status": "${{ job.status }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          

